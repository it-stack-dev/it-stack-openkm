# =============================================================================
# IT-Stack: OpenKM — Lab 04: SSO Integration
# Module 14 · Phase 3 · Lab 04
# =============================================================================
# Services: MySQL · OpenLDAP · Keycloak · Mailhog · OpenKM
# Ports:    OpenKM:8352  Keycloak:8452  LDAP:3892  Mailhog:8652
# Credentials:
#   DB root:   RootLab04!
#   OpenKM DB: openkm / OpenKMLab04!
#   OpenKM UI: okmAdmin / OkmAdmin04!
#   Keycloak:  admin / Admin04!
#   LDAP:      cn=admin,dc=lab,dc=local / LdapLab04!
# What's new vs Lab 03:
#   + OpenLDAP directory; OpenKM LDAP auth via JAVA_OPTS properties
#   + Keycloak 24 dev-mode as SAML/OIDC IdP (it-stack realm)
#   + OpenKM security.ldap.* system properties passed via JAVA_OPTS
#   + Elasticsearch retained from Lab 03 for full-text indexing
#   + Full SSO pipeline: LDAP → Keycloak federation → OpenKM LDAP auth
# =============================================================================

name: it-stack-openkm-lab04

services:

  # ── MySQL ────────────────────────────────────────────────────────────────
  openkm-s04-db:
    image: mysql:8.0
    container_name: openkm-s04-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: RootLab04!
      MYSQL_DATABASE: openkm
      MYSQL_USER: openkm
      MYSQL_PASSWORD: OpenKMLab04!
    volumes:
      - openkm-s04-db-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-uroot", "-pRootLab04!", "--silent"]
      interval: 10s
      timeout: 5s
      retries: 15
    networks:
      - openkm-s04-net
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"

  # ── OpenLDAP ─────────────────────────────────────────────────────────────
  openkm-s04-ldap:
    image: osixia/openldap:1.5.0
    container_name: openkm-s04-ldap
    restart: unless-stopped
    environment:
      LDAP_ORGANISATION: "IT-Stack Lab"
      LDAP_DOMAIN: lab.local
      LDAP_ADMIN_PASSWORD: LdapLab04!
      LDAP_CONFIG_PASSWORD: ConfigLab04!
      LDAP_BASE_DN: dc=lab,dc=local
      LDAP_READONLY_USER: "true"
      LDAP_READONLY_USER_USERNAME: readonly
      LDAP_READONLY_USER_PASSWORD: ReadOnly04!
    ports:
      - "3892:389"
    volumes:
      - openkm-s04-ldap-data:/var/lib/ldap
      - openkm-s04-ldap-config:/etc/ldap/slapd.d
    healthcheck:
      test: ["CMD-SHELL", "ldapsearch -x -H ldap://localhost -b dc=lab,dc=local -D cn=admin,dc=lab,dc=local -w LdapLab04! cn=admin > /dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 15
    networks:
      - openkm-s04-net
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.25"

  # ── Elasticsearch ────────────────────────────────────────────────────────
  openkm-s04-es:
    image: elasticsearch:8.13.2
    container_name: openkm-s04-es
    restart: unless-stopped
    environment:
      discovery.type: single-node
      xpack.security.enabled: "false"
      ES_JAVA_OPTS: "-Xms512m -Xmx512m"
    ports:
      - "9202:9200"
    volumes:
      - openkm-s04-es-data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9200/_cluster/health || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 15
      start_period: 30s
    networks:
      - openkm-s04-net
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "0.5"

  # ── Keycloak ─────────────────────────────────────────────────────────────
  openkm-s04-kc:
    image: quay.io/keycloak/keycloak:24.0.3
    container_name: openkm-s04-kc
    restart: unless-stopped
    command: start-dev
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: Admin04!
      KC_HEALTH_ENABLED: "true"
      KC_DB: dev-file
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
      KC_HTTP_ENABLED: "true"
    ports:
      - "8452:8080"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/realms/master || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 30s
    networks:
      - openkm-s04-net
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1.0"

  # ── Mailhog ──────────────────────────────────────────────────────────────
  openkm-s04-mail:
    image: mailhog/mailhog:latest
    container_name: openkm-s04-mail
    restart: unless-stopped
    ports:
      - "8652:8025"
    networks:
      - openkm-s04-net
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.1"

  # ── OpenKM ───────────────────────────────────────────────────────────────
  openkm-s04-app:
    image: openkm/openkmdce:7.2.0
    container_name: openkm-s04-app
    restart: unless-stopped
    depends_on:
      openkm-s04-db:
        condition: service_healthy
      openkm-s04-ldap:
        condition: service_healthy
      openkm-s04-es:
        condition: service_healthy
    ports:
      - "8352:8080"
    environment:
      OPENKM_DB_DRIVER: com.mysql.cj.jdbc.Driver
      OPENKM_DB_URL: jdbc:mysql://openkm-s04-db:3306/openkm?useSSL=false&serverTimezone=UTC
      OPENKM_DB_USER: openkm
      OPENKM_DB_PASS: OpenKMLab04!
      OPENKM_ES_HOST: openkm-s04-es
      OPENKM_ES_PORT: "9200"
      OPENKM_ADMIN_USER: okmAdmin
      OPENKM_ADMIN_PASS: OkmAdmin04!
      JAVA_OPTS: >-
        -Xms512m -Xmx1g -XX:+UseG1GC
        -Dopenkm.property.security.ldap.enable=true
        -Dopenkm.property.security.ldap.server=ldap://openkm-s04-ldap:389
        -Dopenkm.property.security.ldap.security.principal=cn=admin,dc=lab,dc=local
        -Dopenkm.property.security.ldap.security.credentials=LdapLab04!
        -Dopenkm.property.security.ldap.users.dn=ou=users,dc=lab,dc=local
        -Dopenkm.property.security.ldap.groups.dn=ou=groups,dc=lab,dc=local
    volumes:
      - openkm-s04-data:/opt/openkm/repository
      - openkm-s04-logs:/opt/openkm/log
    networks:
      - openkm-s04-net
    deploy:
      resources:
        limits:
          memory: 1536M
          cpus: "1.0"

# ── Networks ─────────────────────────────────────────────────────────────────
networks:
  openkm-s04-net:
    name: openkm-s04-net
    driver: bridge

# ── Volumes ──────────────────────────────────────────────────────────────────
volumes:
  openkm-s04-db-data:
  openkm-s04-ldap-data:
  openkm-s04-ldap-config:
  openkm-s04-es-data:
  openkm-s04-data:
  openkm-s04-logs:
